;;
;; Copyright (c) 2021-2022 Ian Fitchet <idf(at)idio-lang.org>
;;
;; Licensed under the Apache License, Version 2.0 (the "License"); you
;; may not use this file except in compliance with the License.  You
;; may obtain a copy of the License at
;;
;;     http://www.apache.org/licenses/LICENSE-2.0
;;
;; Unless required by applicable law or agreed to in writing, software
;; distributed under the License is distributed on an "AS IS" BASIS,
;; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;; See the License for the specific language governing permissions and
;; limitations under the License.
;;
;;

;;
;; test-libc-wrap-error.idio
;;

module tests/libc-wrap
import libc

libc-wrap-error0 := Tests
libc-wrap-error-skipped := 0

#*

We have a bunch of test cases which should provoke a ^rt-libc-error,
^system-error or ^rt-parameter-error.  So we can write a load function
which will wrapper the actual load with a trap for
(^rt-libc-error ...) and compare the message strings.

*#

libc-wrap-error-load := {
  n := 0

  function/name libc-wrap-error-load (filename msg & args) {
    if (not (string? filename)) (error/type ^rt-parameter-type-error 'load "string" filename)

    n = n + 1

    exp-tests := 1
    if (pair? args) {
      exp-tests = 3
    }

    test-report "loading #%s %s looking for %s\n" n filename msg
    trap (^rt-libc-error
	  ^system-error
	  ^rt-parameter-error) (function (c) {
	    ;eprintf "libc-wrap-error #%s: %s %s\n" n msg (idio-error-location c)
	    test (idio-error-message c) msg

	    if (not (string=? (idio-error-message c) msg)) {
	      condition-report (append-string "libc-wrap-error-load: " filename) c (current-error-handle)
	    }

	    if (system-error? c) {
	      tested := #f
	      if (pair? args) {
		test (system-error-errno c) (ph args)
		if (pair? (pt args)) {
		  test (system-error-function c) (pht args)
		  tested = #t
		}
	      } 

	      if (not tested) {
		condition-report (append-string "libc-wrap-error-load: " filename) c (current-error-handle)
	      }
	    }

	    trap-return 'libc-wrap-error
	  }) {
	    t0 := Tests
	    (symbol-value 'load 'Idio) filename
	    if (not (equal? Tests (t0 + exp-tests))) {
	      eprintf "libc-wrap-error #%s: %s did not generate \"%s\"\n" n filename msg
	      Errors = Errors + 1
	      Tests = t0 + exp-tests
	    }
    }
  }
}

;; EBADF's strerror(3) form differs across systems
strerror-EBADF := strerror EBADF

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;; src/libc-api.c

libc-wrap-error-load "libc-wrap-errors/struct-group-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-group-ref-invalid-pointer-type.idio" "struct-group-ref group='#<C/* C/pointer>' a C/pointer is not a libc/struct-group"
libc-wrap-error-load "libc-wrap-errors/struct-group-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-group-ref-invalid-member.idio" "struct-group-ref member='not-likely' a symbol is not a libc/struct-group member"

libc-wrap-error-load "libc-wrap-errors/struct-group-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-group-as-string-invalid-pointer-type.idio" "struct-group-as-string group='#<C/* C/pointer>' a C/pointer is not a libc/struct-group"

libc-wrap-error-load "libc-wrap-errors/struct-passwd-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-passwd-ref-invalid-pointer-type.idio" "struct-passwd-ref passwd='#<C/* C/pointer>' a C/pointer is not a libc/struct-passwd"
libc-wrap-error-load "libc-wrap-errors/struct-passwd-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-passwd-ref-invalid-member.idio" "struct-passwd-ref member='not-likely' a symbol is not a libc/struct-passwd member"

libc-wrap-error-load "libc-wrap-errors/struct-passwd-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-passwd-as-string-invalid-pointer-type.idio" "struct-passwd-as-string passwd='#<C/* C/pointer>' a C/pointer is not a libc/struct-passwd"

libc-wrap-error-load "libc-wrap-errors/struct-rlimit-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-ref-invalid-pointer-type.idio" "struct-rlimit-ref rlimit='#<C/* C/pointer>' a C/pointer is not a libc/struct-rlimit"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-ref-invalid-member.idio" "struct-rlimit-ref member='not-likely' a symbol is not a libc/struct-rlimit member"

libc-wrap-error-load "libc-wrap-errors/struct-rlimit-set-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-set-invalid-pointer-type.idio" "struct-rlimit-set! rlimit='#<C/* C/pointer>' a C/pointer is not a libc/struct-rlimit"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-set-rlim_cur-bad-value-type.idio" "bad parameter type: '#t' a constant is not a libc/rlim_t"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-set-rlim_max-bad-value-type.idio" "bad parameter type: '#t' a constant is not a libc/rlim_t"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-set-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-set-invalid-member.idio" "struct-rlimit-set! member='not-likely' a symbol is not a libc/struct-rlimit member"

libc-wrap-error-load "libc-wrap-errors/struct-rlimit-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-rlimit-as-string-invalid-pointer-type.idio" "struct-rlimit-as-string rlimit='#<C/* C/pointer>' a C/pointer is not a libc/struct-rlimit"

libc-wrap-error-load "libc-wrap-errors/struct-rusage-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-rusage-ref-invalid-pointer-type.idio" "struct-rusage-ref rusage='#<C/* C/pointer>' a C/pointer is not a libc/struct-rusage"
libc-wrap-error-load "libc-wrap-errors/struct-rusage-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-rusage-ref-invalid-member.idio" "struct-rusage-ref member='not-likely' a symbol is not a libc/struct-rusage member"

libc-wrap-error-load "libc-wrap-errors/struct-rusage-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-rusage-as-string-invalid-pointer-type.idio" "struct-rusage-as-string rusage='#<C/* C/pointer>' a C/pointer is not a libc/struct-rusage"

libc-wrap-error-load "libc-wrap-errors/struct-stat-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-stat-ref-invalid-pointer-type.idio" "struct-stat-ref stat='#<C/* C/pointer>' a C/pointer is not a libc/struct-stat"
libc-wrap-error-load "libc-wrap-errors/struct-stat-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-stat-ref-invalid-member.idio" "struct-stat-ref member='not-likely' a symbol is not a libc/struct-stat member"

libc-wrap-error-load "libc-wrap-errors/struct-stat-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-stat-as-string-invalid-pointer-type.idio" "struct-stat-as-string stat='#<C/* C/pointer>' a C/pointer is not a libc/struct-stat"

libc-wrap-error-load "libc-wrap-errors/struct-termios-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-termios-ref-invalid-pointer-type.idio" "struct-termios-ref termios='#<C/* C/pointer>' a C/pointer is not a libc/struct-termios"
libc-wrap-error-load "libc-wrap-errors/struct-termios-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-termios-ref-invalid-member.idio" "struct-tms-ref member='not-likely' a symbol is not a libc/struct-termios member"

libc-wrap-error-load "libc-wrap-errors/struct-termios-set-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-termios-set-invalid-pointer-type.idio" "struct-termios-set! termios='#<C/* C/pointer>' a C/pointer is not a libc/struct-termios"
libc-wrap-error-load "libc-wrap-errors/struct-termios-set-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-termios-set-invalid-member.idio" "struct-termios-set! member='not-likely' a symbol is not a libc/struct-termios member"

libc-wrap-error-load "libc-wrap-errors/struct-termios-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-termios-as-string-invalid-pointer-type.idio" "struct-termios-as-string termios='#<C/* C/pointer>' a C/pointer is not a libc/struct-termios"

libc-wrap-error-load "libc-wrap-errors/struct-timespec-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-ref-invalid-pointer-type.idio" "struct-timespec-ref timespec='#<C/* C/pointer>' a C/pointer is not a libc/struct-timespec"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-ref-invalid-member.idio" "struct-timespec-ref member='not-likely' a symbol is not a libc/struct-timespec member"

libc-wrap-error-load "libc-wrap-errors/struct-timespec-set-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-set-invalid-pointer-type.idio" "struct-timespec-set! timespec='#<C/* C/pointer>' a C/pointer is not a libc/struct-timespec"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-set-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-set-invalid-member.idio" "struct-timespec-set! member='not-likely' a symbol is not a libc/struct-timespec member"

libc-wrap-error-load "libc-wrap-errors/struct-timespec-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-timespec-as-string-invalid-pointer-type.idio" "struct-timespec-as-string timespec='#<C/* C/pointer>' a C/pointer is not a libc/struct-timespec"

libc-wrap-error-load "libc-wrap-errors/struct-timeval-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-ref-invalid-pointer-type.idio" "struct-timeval-ref timeval='#<C/* C/pointer>' a C/pointer is not a libc/struct-timeval"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-ref-invalid-member.idio" "struct-timeval-ref member='not-likely' a symbol is not a libc/struct-timeval member"

libc-wrap-error-load "libc-wrap-errors/struct-timeval-set-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-set-invalid-pointer-type.idio" "struct-timeval-set! timeval='#<C/* C/pointer>' a C/pointer is not a libc/struct-timeval"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-set-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-set-invalid-member.idio" "struct-timeval-set! member='not-likely' a symbol is not a libc/struct-timeval member"

libc-wrap-error-load "libc-wrap-errors/struct-timeval-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-timeval-as-string-invalid-pointer-type.idio" "struct-timeval-as-string timeval='#<C/* C/pointer>' a C/pointer is not a libc/struct-timeval"

libc-wrap-error-load "libc-wrap-errors/add-struct-timeval-bad-first-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/add-struct-timeval-bad-second-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"

libc-wrap-error-load "libc-wrap-errors/subtract-struct-timeval-bad-first-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/subtract-struct-timeval-bad-second-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"

libc-wrap-error-load "libc-wrap-errors/struct-tm-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-tm-ref-invalid-pointer-type.idio" "struct-tm-ref tm='#<C/* C/pointer>' a C/pointer is not a libc/struct-tm"
libc-wrap-error-load "libc-wrap-errors/struct-tm-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-tm-ref-invalid-member.idio" "struct-tm-ref member='not-likely' a symbol is not a libc/struct-tm member"

libc-wrap-error-load "libc-wrap-errors/struct-tm-set-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-tm-set-invalid-pointer-type.idio" "struct-tm-set! tm='#<C/* C/pointer>' a C/pointer is not a libc/struct-tm"
libc-wrap-error-load "libc-wrap-errors/struct-tm-set-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-tm-set-invalid-member.idio" "struct-tm-set! member='not-likely' a symbol is not a libc/struct-tm member"

libc-wrap-error-load "libc-wrap-errors/struct-tm-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-tm-as-string-invalid-pointer-type.idio" "struct-tm-as-string tm='#<C/* C/pointer>' a C/pointer is not a libc/struct-tm"

libc-wrap-error-load "libc-wrap-errors/struct-tms-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-tms-ref-invalid-pointer-type.idio" "struct-tms-ref tms='#<C/* C/pointer>' a C/pointer is not a libc/struct-tms"
libc-wrap-error-load "libc-wrap-errors/struct-tms-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-tms-ref-invalid-member.idio" "struct-tms-ref member='not-likely' a symbol is not a libc/struct-tms member"

libc-wrap-error-load "libc-wrap-errors/struct-tms-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-tms-as-string-invalid-pointer-type.idio" "struct-tms-as-string tms='#<C/* C/pointer>' a C/pointer is not a libc/struct-tms"

libc-wrap-error-load "libc-wrap-errors/struct-utsname-ref-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-utsname-ref-invalid-pointer-type.idio" "struct-utsname-ref utsname='#<C/* C/pointer>' a C/pointer is not a libc/struct-utsname"
libc-wrap-error-load "libc-wrap-errors/struct-utsname-ref-bad-member-type.idio" "bad parameter type: '#t' a constant is not a symbol"
libc-wrap-error-load "libc-wrap-errors/struct-utsname-ref-invalid-member.idio" "struct-utsname-ref member='not-likely' a symbol is not a libc/struct-utsname member"

libc-wrap-error-load "libc-wrap-errors/struct-utsname-as-string-bad-pointer-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/struct-utsname-as-string-invalid-pointer-type.idio" "struct-utsname-as-string utsname='#<C/* C/pointer>' a C/pointer is not a libc/struct-utsname"

libc-wrap-error-load "libc-wrap-errors/access-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/access-bad-pathname-format.idio" "access: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/access-bad-mode-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/asctime-bad-tm-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/asctime-tm-invalid-pointer-type.idio" "asctime tm='#<C/* C/pointer>' a C/pointer is not a libc/struct-tm"

libc-wrap-error-load "libc-wrap-errors/chdir-bad-path-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/chdir-bad-path-format.idio" "chdir: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/chdir-non-existent.idio" "No such file or directory" ENOENT "chdir"

libc-wrap-error-load "libc-wrap-errors/chmod-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/chmod-bad-pathname-format.idio" "chmod: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/chmod-bad-mode-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"
libc-wrap-error-load "libc-wrap-errors/chmod-pathname-ENOENT.idio" "No such file or directory" ENOENT "chmod"

libc-wrap-error-load "libc-wrap-errors/chown-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/chown-bad-pathname-format.idio" "chown: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/chown-bad-owner-type.idio" "bad parameter type: '#t' a constant is not a libc/uid_t"
libc-wrap-error-load "libc-wrap-errors/chown-bad-group-type.idio" "bad parameter type: '#t' a constant is not a libc/gid_t"
libc-wrap-error-load "libc-wrap-errors/chown-pathname-ENOENT.idio" "No such file or directory" ENOENT "chown"

libc-wrap-error-load "libc-wrap-errors/chroot-bad-path-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/chroot-bad-path-format.idio" "chroot: contains an ASCII NUL"
(cond-expand
 ((or "uname/sysname/OpenBSD"
      "uname/sysname/FreeBSD"
      "uname/sysname/NetBSD"
      "uname/sysname/Darwin") {
   libc-wrap-error-load "libc-wrap-errors/chroot-path-non-existent.idio" "Operation not permitted" EPERM "chroot"
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/chroot-path-non-existent.idio" "No such file or directory" ENOENT "chroot"
 }))

libc-wrap-error-load "libc-wrap-errors/close-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/close-bad-fd.idio" strerror-EBADF EBADF "close"

libc-wrap-error-load "libc-wrap-errors/ctime-bad-t-type.idio" "bad parameter type: '#t' a constant is not a libc/time_t"

libc-wrap-error-load "libc-wrap-errors/dup-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/dup-bad-fd.idio" strerror-EBADF EBADF "dup"

libc-wrap-error-load "libc-wrap-errors/dup2-bad-old-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/dup2-bad-new-type.idio" "bad parameter type: '#t' a constant is not a fixnum|C/int"
libc-wrap-error-load "libc-wrap-errors/dup2-bad-fd.idio" strerror-EBADF EBADF "dup2"

libc-wrap-error-load "libc-wrap-errors/exit-bad-type.idio" "bad parameter type: '#t' a constant is not a fixnum|C/int"

libc-wrap-error-load "libc-wrap-errors/fchdir-bad-fd-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fchdir-not-a-directory.idio" "Not a directory" ENOTDIR "fchdir"

libc-wrap-error-load "libc-wrap-errors/fchmod-bad-fd-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fchmod-bad-mode-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"
libc-wrap-error-load "libc-wrap-errors/fchmod-non-existent.idio" strerror-EBADF EBADF "fchmod"

libc-wrap-error-load "libc-wrap-errors/fcntl-bad-fd-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fcntl-bad-cmd-type.idio" "bad parameter type: '1' a fixnum is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fcntl-F_DUPFD-bad-arg-type.idio" "bad parameter type: '#t' a constant is not a C/int"
(cond-expand
 (libc/F_DUPFD_CLOEXEC {
   libc-wrap-error-load "libc-wrap-errors/fcntl-F_DUPFD_CLOEXEC-bad-arg-type.idio" "bad parameter type: '#t' a constant is not a C/int"
 })
 (else {
   printf "no F_DUPFD_CLOEXEC on this system, skipping\n"
   test #t #t
 }))
libc-wrap-error-load "libc-wrap-errors/fcntl-F_SETFD-bad-arg-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fcntl-F_SETFL-bad-arg-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fcntl-unknown-cmd.idio" "fcntl cmd='98765': unexpected cmd"

libc-wrap-error-load "libc-wrap-errors/fcntl-F_DUPFD-bad-fd.idio" strerror-EBADF EBADF "fcntl"

libc-wrap-error-load "libc-wrap-errors/fstat-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/fstat-bad-fd.idio" strerror-EBADF EBADF "fstat"

(cond-expand
 ("uname/sysname/SunOS" {
   ;; SunOS won't let you rmdir "." or any equivalent => EINVAL
   eprintf "NOTICE: SunOS: skipping test using rmdir .\n"
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 (else {
   cwd := (getcwd)
   libc-wrap-error-load "libc-wrap-errors/getcwd-non-existent.idio" "No such file or directory" ENOENT "getcwd"
   chdir cwd
 }))

libc-wrap-error-load "libc-wrap-errors/getgrgid-bad-gid-type.idio" "bad parameter type: '#t' a constant is not a unsigned fixnum|libc/gid_t"

libc-wrap-error-load "libc-wrap-errors/getgrnam-bad-name-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/getgrnam-bad-name-format.idio" "getgrnam: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/getpgid-bad-pid-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
(cond-expand
 ("uname/sysname/SunOS" {
   libc-wrap-error-load "libc-wrap-errors/getpgid-bad-pid.idio" "Invalid argument" EINVAL "getpgid"
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/getpgid-bad-pid.idio" "No such process" ESRCH "getpgid"
 }))

libc-wrap-error-load "libc-wrap-errors/getpwnam-bad-name-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/getpwnam-bad-name-format.idio" "getpwnam: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/getpwuid-bad-uid-type.idio" "bad parameter type: '#t' a constant is not a unsigned fixnum|libc/uid_t"

libc-wrap-error-load "libc-wrap-errors/getrlimit-bad-resource-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/getrlimit-bad-resource-nickname.idio" "getrlimit bad resource (:NOT_LIKELY)"
libc-wrap-error-load "libc-wrap-errors/getrlimit-bad-rlim.idio" "Invalid argument" EINVAL "getrlimit"

libc-wrap-error-load "libc-wrap-errors/getrusage-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/getrusage-bad-who.idio" "Invalid argument" EINVAL "getrusage"

libc-wrap-error-load "libc-wrap-errors/getsid-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
(cond-expand
 ("uname/sysname/SunOS" {
   ;; OpenIndiana returns EIVAL which isn't even listed on the man page
   libc-wrap-error-load "libc-wrap-errors/getsid-invalid-pid.idio" "Invalid argument" EINVAL "getsid"
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/getsid-invalid-pid.idio" "No such process" ESRCH "getsid"
 }))

libc-wrap-error-load "libc-wrap-errors/gmtime-bad-t-type.idio" "bad parameter type: '#t' a constant is not a libc/time_t"

libc-wrap-error-load "libc-wrap-errors/grantpt-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/ioctl-unknown-cmd.idio" "ioctl cmd='98765': unexpected cmd"

libc-wrap-error-load "libc-wrap-errors/isatty-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
(cond-expand
 ("uname/sysname/SunOS" {
   ;; these don't set errno in this case
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 (else {
   ;; The Linux manpage notes: On some older kernels, some types of files
   ;; resulted in the error EINVAL in this case (which is a violation of
   ;; POSIX, which specifies the error ENOTTY).
   libc-wrap-error-load "libc-wrap-errors/isatty-not-tty.idio" strerror-EBADF EBADF "isatty"
 }))

libc-wrap-error-load "libc-wrap-errors/kill-bad-pid-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
libc-wrap-error-load "libc-wrap-errors/kill-bad-sig-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/kill-invalid-signal.idio" "Invalid argument" EINVAL "kill"

libc-wrap-error-load "libc-wrap-errors/killpg-bad-pgrp-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
libc-wrap-error-load "libc-wrap-errors/killpg-bad-sig-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/localtime-bad-t-type.idio" "bad parameter type: '#t' a constant is not a libc/time_t"

libc-wrap-error-load "libc-wrap-errors/lstat-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/lstat-bad-pathname-format.idio" "lstat: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/lstat-empty-pathname.idio" "No such file or directory" ENOENT "lstat"

libc-wrap-error-load "libc-wrap-errors/mkdir-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/mkdir-bad-pathname-format.idio" "mkdir: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/mkdir-bad-mode-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"
libc-wrap-error-load "libc-wrap-errors/mkdir-pathname-exists.idio" "File exists" EEXIST "mkdir"

libc-wrap-error-load "libc-wrap-errors/mkdtemp-bad-template-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/mkdtemp-bad-template-format.idio" "mkdtemp: contains an ASCII NUL"
(cond-expand
 ((or "uname/sysname/SunOS"
      "uname/sysname/FreeBSD"
      "uname/sysname/NetBSD"
      "uname/sysname/Darwin") {
   ;; SunOS/FreeBSD/Mac OS appear to be considerably more relaxed
   ;; about the template
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/mkdtemp-bad-template.idio" "Invalid argument" EINVAL "mkdtemp"
 }))

libc-wrap-error-load "libc-wrap-errors/mkfifo-bad-path-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/mkfifo-bad-path-format.idio" "mkfifo: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/mkfifo-bad-mode-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/mkstemp-bad-template-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/mkstemp-bad-template-format.idio" "mkstemp: contains an ASCII NUL"
(cond-expand
 ((or "uname/sysname/SunOS"
      "uname/sysname/FreeBSD"
      "uname/sysname/NetBSD"
      "uname/sysname/Darwin") {
   ;; SunOS/FreeBSD/Mac OS appear to be considerably more relaxed
   ;; about the template
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/mkstemp-bad-template.idio" "Invalid argument" EINVAL "mkstemp"
 }))

libc-wrap-error-load "libc-wrap-errors/mktime-bad-tm-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/mktime-tm-invalid-pointer-type.idio" "mktime tm='#<C/* C/pointer>' a C/pointer is not a libc/struct-tm"

libc-wrap-error-load "libc-wrap-errors/mktime-bad-tm-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"

libc-wrap-error-load "libc-wrap-errors/nanosleep-bad-req-type.idio" "bad parameter type: '#t' a constant is not a struct timespec|list"
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-sec-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/time_t|fixnum|bignum"
(cond-expand
 ((or "uname/sysname/FreeBSD"
      "uname/sysname/NetBSD") {
   ;; FreeBSD treats negative seconds as zero?
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/nanosleep-req-sec-negative.idio" "Invalid argument" EINVAL "nanosleep"
 }))
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-sec-float.idio" "nanosleep sec='1.1e+0' a bignum is not a an integer bignum"
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-nsec-bad-type.idio" "bad parameter type: '#t' a constant is not a C/long|fixnum|bignum"
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-nsec-negative.idio" "Invalid argument" EINVAL "nanosleep"
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-nsec-float.idio" "nanosleep nsec='1.1e+0' a bignum is not a an integer bignum"
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-nsec-range.idio" "Invalid argument" EINVAL "nanosleep"
libc-wrap-error-load "libc-wrap-errors/nanosleep-req-invalid-pointer-type.idio" "nanosleep req='#<C/* C/pointer>' a C/pointer is not a libc/struct-timespec"

libc-wrap-error-load "libc-wrap-errors/open-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/open-bad-pathname-format.idio" "open: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/open-bad-flags-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/open-bad-mode-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/pipe-reader-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/pipe-writer-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"

libc-wrap-error-load "libc-wrap-errors/posix_openpt-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/ptsname-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/read-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/read-bad-count-type.idio" "bad parameter type: '#t' a constant is not a fixnum|libc/size_t"

libc-wrap-error-load "libc-wrap-errors/rmdir-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/rmdir-bad-pathname-format.idio" "rmdir: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/rmdir-non-existent.idio" "No such file or directory" ENOENT "rmdir"

libc-wrap-error-load "libc-wrap-errors/setpgid-bad-pid-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
libc-wrap-error-load "libc-wrap-errors/setpgid-bad-pgid-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
libc-wrap-error-load "libc-wrap-errors/setpgid-negative-pgid.idio" "Invalid argument" EINVAL "setpgid"

libc-wrap-error-load "libc-wrap-errors/setrlimit-bad-resource-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/setrlimit-bad-resource-nickname.idio" "setrlimit bad resource (:NOT_LIKELY)"
libc-wrap-error-load "libc-wrap-errors/setrlimit-bad-rlim-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/setrlimit-rlim-invalid-pointer-type.idio" "setrlimit rlim='#<C/* C/pointer>' a C/pointer is not a libc/struct-rlimit"
libc-wrap-error-load "libc-wrap-errors/setrlimit-bad-rlim.idio" "Invalid argument" EINVAL "setrlimit"

libc-wrap-error-load "libc-wrap-errors/signal-bad-sig-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/signal-bad-handler-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/signal-bad-signal.idio" "Invalid argument" EINVAL "signal"

libc-wrap-error-load "libc-wrap-errors/signal-handler-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/signal-handler-bad-signal.idio" "Invalid argument" EINVAL "sigaction"

libc-wrap-error-load "libc-wrap-errors/sleep-bad-type.idio" "bad parameter type: '#t' a constant is not a unsigned fixnum|C/uint"

libc-wrap-error-load "libc-wrap-errors/stat-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/stat-bad-pathname-format.idio" "stat: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/stat-empty-pathname.idio" "No such file or directory" ENOENT "stat"

libc-wrap-error-load "libc-wrap-errors/strerror-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

; strerror -1 => "Unknown error -1" => all ints are "valid" as in not
; EINVAL
;libc-wrap-error-load "libc-wrap-errors/strerror-bad-errnum.idio" "bad parameter type: '#t' a constant is not a unsigned fixnum|C_uint" EINVAL

libc-wrap-error-load "libc-wrap-errors/strftime-bad-format-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/strftime-bad-format-format.idio" "strftime: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/strftime-bad-tm-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/strftime-tm-invalid-pointer-type.idio" "strftime tm='#<C/* C/pointer>' a C/pointer is not a libc/struct-tm"

libc-wrap-error-load "libc-wrap-errors/strptime-bad-s-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/strptime-bad-s-format.idio" "strptime: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/strptime-bad-format-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/strptime-bad-format-format.idio" "strptime: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/strsignal-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
(cond-expand
 ("uname/sysname/SunOS" {
   test (strsignal (C/integer-> -1)) #n
 })
 ((or "uname/sysname/OpenBSD"
      "uname/sysname/NetBSD") {
   ;; the interface appears to be defined as char * strsignal(int sig)
   ;; yet this result appears to be uint32_t - 1
   test (strsignal (C/integer-> -1)) "Unknown signal: 4294967295"
 })
 ((or "uname/sysname/FreeBSD"
      "uname/sysname/Darwin") {
   test (strsignal (C/integer-> -1)) "Unknown signal: -1"
 })

 ;; This Alpine clause is probably a musl libc clause but
 ;; https://wiki.musl-libc.org/faq.html says they refuse to be
 ;; identified
 ("os-release/ID/alpine" {
   (pattern-case
    IDIO_SYSTEM_ARCH
    ("*-musl" {
      test (strsignal (C/integer-> -1)) "Unknown signal"
    })
    (else {
      test (strsignal (C/integer-> -1)) "Unknown signal -1"
    }))
 })
 (else {
   test (strsignal (C/integer-> -1)) "Unknown signal -1"
 }))

libc-wrap-error-load "libc-wrap-errors/tcgetattr-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/tcgetattr-bad-fd.idio" strerror-EBADF EBADF "tcgetattr"

libc-wrap-error-load "libc-wrap-errors/tcgetpgrp-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/tcgetpgrp-bad-fd.idio" strerror-EBADF EBADF "tcgetpgrp"

libc-wrap-error-load "libc-wrap-errors/tcsetattr-bad-fd-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/tcsetattr-bad-options-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/tcsetattr-bad-tcattrs-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
(cond-expand
 ("uname/sysname/SunOS" {
   libc-wrap-error-load "libc-wrap-errors/tcsetattr-bad-fd.idio" "Invalid argument" EINVAL "tcsetattr"
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/tcsetattr-bad-fd.idio" strerror-EBADF EBADF "tcsetattr"
 }))

libc-wrap-error-load "libc-wrap-errors/tcsetpgrp-bad-fd-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/tcsetpgrp-bad-pgrp-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
libc-wrap-error-load "libc-wrap-errors/tcsetpgrp-bad-fd.idio" strerror-EBADF EBADF "tcsetpgrp"

libc-wrap-error-load "libc-wrap-errors/unlink-bad-pathname-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/unlink-bad-pathname-format.idio" "unlink: contains an ASCII NUL"
libc-wrap-error-load "libc-wrap-errors/unlink-non-existent.idio" "No such file or directory" ENOENT "unlink"

libc-wrap-error-load "libc-wrap-errors/unlockpt-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/waitpid-bad-pid-type.idio" "bad parameter type: '#t' a constant is not a libc/pid_t"
libc-wrap-error-load "libc-wrap-errors/waitpid-bad-options-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/waitpid-bad-options.idio" "Invalid argument" EINVAL "waitpid"

libc-wrap-error-load "libc-wrap-errors/WEXITSTATUS-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/WIFEXITED-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/WIFSIGNALED-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/WIFSTOPPED-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"
libc-wrap-error-load "libc-wrap-errors/WTERMSIG-bad-type.idio" "bad parameter type: '#t' a constant is not a C/pointer"

libc-wrap-error-load "libc-wrap-errors/write-bad-fd-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/write-bad-str-type.idio" "bad parameter type: '#t' a constant is not a string"
libc-wrap-error-load "libc-wrap-errors/write-bad-fd.idio" strerror-EBADF EBADF "write"

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;; src/libc-wrap.c

libc-wrap-error-load "libc-wrap-errors/sig-name-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/signal-name-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/signal-name-bad-signum.idio" "sig-name signum='-1': should be 0 < int < NSIG (OS dependent)"

libc-wrap-error-load "libc-wrap-errors/errno-name-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/errno-name-bad-errnum.idio" "errno-name errnum='-1': should be 0 < int < NERRNO (OS dependent)"

libc-wrap-error-load "libc-wrap-errors/strerrno-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/rlimit-name-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"
libc-wrap-error-load "libc-wrap-errors/rlimit-name-bad-rlim.idio" "rlimit-name rlim='-1': should be an 0 <= int < RLIM_NLIMITS"

;; XXX unwise failure choices prompted by NetBSD

;; The problem is 1) using -1 as an invalid UID/GID when a UID/GID is
;; unsigned (who knew?) and 2) NetBSD *does not fail* with a negative
;; UID/GID.

;; The solution is to use a non-negative invalid UID/GID which means
;; we need to attempt to get UIDs/GIDs by ID until we fail...

;; a UID of 20 seems generally unused; a GID of 17 seems ok too but we
;; need to inch along looking for a free UID/GID
unused-UID := (C/for ((i 20 (i + 1))) (i lt 1000) {
  if (not (getpwuid i)) {
    break i
  }
})
unused-GID := (C/for ((i 17 (i + 1))) (i lt 1000) {
  if (not (getgrgid i)) {
    break i
  }
})

libc-wrap-error-load "libc-wrap-errors/EGID-set-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/gid_t"
(cond-expand
 ("uname/sysname/NetBSD" {
   ;; NetBSD ignores a negative GID
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })

 ;; This Alpine clause is probably a musl libc clause but
 ;; https://wiki.musl-libc.org/faq.html says they refuse to be
 ;; identified
 ("os-release/ID/alpine" {
   (pattern-case
    IDIO_SYSTEM_ARCH
    ("*-musl" {
      libc-wrap-error-skipped = libc-wrap-error-skipped + 3
    })
    (else {
      libc-wrap-error-load "libc-wrap-errors/EGID-set-invalid-gid.idio" "Invalid argument" EINVAL "setegid"
    }))
 })
 ((or "uname/sysname/FreeBSD"
      "uname/sysname/OpenBSD"
      "uname/sysname/Darwin") {
   if running-as-root {
     eprintf "NOTICE: EUID == 0: skipping set EGID invalid GID failure test\n"
     libc-wrap-error-skipped = libc-wrap-error-skipped + 3
   } {
     libc-wrap-error-load "libc-wrap-errors/EGID-set-invalid-gid.idio" "Operation not permitted" EPERM "setegid"
   }
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/EGID-set-invalid-gid.idio" "Invalid argument" EINVAL "setegid"
 })
)

if running-as-root {
  eprintf "NOTICE: EUID == 0: skipping set EGID unused GID failure test\n"
  libc-wrap-error-skipped = libc-wrap-error-skipped + 3
} {
  (cond-expand
   ("uname/sysname/SunOS" {
     (cond-expand
      ("os-release/ID/solaris" {
	;; Oracle Solaris 11.4
	libc-wrap-error-load "libc-wrap-errors/EGID-set-unused-gid.idio" "Insufficient privileges" EPERM "setegid"
      })
      (else {
	libc-wrap-error-load "libc-wrap-errors/EGID-set-unused-gid.idio" "Not owner" EPERM "setegid"
      }))
   })
   (else {
     libc-wrap-error-load "libc-wrap-errors/EGID-set-unused-gid.idio" "Operation not permitted" EPERM "setegid"
   }))
}

libc-wrap-error-load "libc-wrap-errors/EUID-set-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/uid_t"
(cond-expand
 ("uname/sysname/NetBSD" {
   ;; NetBSD ignores a negative UID
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })

 ;; This Alpine clause is probably a musl libc clause but
 ;; https://wiki.musl-libc.org/faq.html says they refuse to be
 ;; identified
 ("os-release/ID/alpine" {
   (pattern-case
    IDIO_SYSTEM_ARCH
    ("*-musl" {
      libc-wrap-error-skipped = libc-wrap-error-skipped + 3
    })
    (else {
      libc-wrap-error-load "libc-wrap-errors/EGID-set-invalid-gid.idio" "Invalid argument" EINVAL "setegid"
    }))
 })
 ((or "uname/sysname/FreeBSD"
      "uname/sysname/OpenBSD"
      "uname/sysname/Darwin") {
   if running-as-root {
     eprintf "NOTICE: EUID == 0: skipping set EUID invalid UID failure test\n"
     libc-wrap-error-skipped = libc-wrap-error-skipped + 3
   } {
     libc-wrap-error-load "libc-wrap-errors/EUID-set-invalid-uid.idio" "Operation not permitted" EPERM "seteuid"
   }
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/EUID-set-invalid-uid.idio" "Invalid argument" EINVAL "seteuid"
 })
)

if running-as-root {
  eprintf "NOTICE: EUID == 0: skipping set EUID unused UID failure test\n"
  libc-wrap-error-skipped = libc-wrap-error-skipped + 3
} {
  (cond-expand
   ("uname/sysname/SunOS" {
     (cond-expand
      ("os-release/ID/solaris" {
	;; Oracle Solaris 11.4
	libc-wrap-error-load "libc-wrap-errors/EUID-set-unused-uid.idio" "Insufficient privileges" EPERM "seteuid"
      })
      (else {
	libc-wrap-error-load "libc-wrap-errors/EUID-set-unused-uid.idio" "Not owner" EPERM "seteuid"
      }))
   })
   (else {
     libc-wrap-error-load "libc-wrap-errors/EUID-set-unused-uid.idio" "Operation not permitted" EPERM "seteuid"
   }))
}

libc-wrap-error-load "libc-wrap-errors/GID-set-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/gid_t"
(cond-expand
 (virtualisation/WSL {
   ;; WSL doesn't generate an error...
   eprintf "NOTICE: WSL: skipping GID assignment test\n"
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 ("uname/sysname/NetBSD" {
   ;; NetBSD ignores a negative GID
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 ((or "uname/sysname/FreeBSD"
      "uname/sysname/OpenBSD"
      "uname/sysname/Darwin"
      (and "os-release/ID/CentOS"
	   "os-release/VERSION_ID/6")) {
   if running-as-root {
     eprintf "NOTICE: EUID == 0: skipping set GID invalid GID failure test\n"
     libc-wrap-error-skipped = libc-wrap-error-skipped + 3
   } {
     libc-wrap-error-load "libc-wrap-errors/GID-set-invalid-gid.idio" "Operation not permitted" EPERM "setgid"
   }
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/GID-set-invalid-gid.idio" "Invalid argument" EINVAL "setgid"
 })
)

if running-as-root {
  eprintf "NOTICE: EUID == 0: skipping set GID unused GID failure test\n"
  libc-wrap-error-skipped = libc-wrap-error-skipped + 3
} {
  (cond-expand
   ("uname/sysname/SunOS" {
     (cond-expand
      ("os-release/ID/solaris" {
	;; Oracle Solaris 11.4
	libc-wrap-error-load "libc-wrap-errors/GID-set-unused-gid.idio" "Insufficient privileges" EPERM "setgid"
      })
      (else {
	libc-wrap-error-load "libc-wrap-errors/GID-set-unused-gid.idio" "Not owner" EPERM "setgid"
      }))
   })
   (else {
     libc-wrap-error-load "libc-wrap-errors/GID-set-unused-gid.idio" "Operation not permitted" EPERM "setgid"
   }))
}

libc-wrap-error-load "libc-wrap-errors/UID-set-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/uid_t"
(cond-expand
 (virtualisation/WSL {
   ;; WSL doesn't generate an error...
   eprintf "NOTICE: WSL: skipping UID assignment test\n"
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 ("uname/sysname/NetBSD" {
   ;; NetBSD ignores a negative UID
   libc-wrap-error-skipped = libc-wrap-error-skipped + 3
 })
 ((or "uname/sysname/FreeBSD"
      "uname/sysname/OpenBSD"
      "uname/sysname/Darwin"
      (and "os-release/ID/CentOS"
	   "os-release/VERSION_ID/6")) {
   if running-as-root {
     eprintf "NOTICE: EUID == 0: skipping set UID invalid UID failure test\n"
     libc-wrap-error-skipped = libc-wrap-error-skipped + 3
   } {
     libc-wrap-error-load "libc-wrap-errors/UID-set-invalid-uid.idio" "Operation not permitted" EPERM "setuid"
   }
 })
 (else {
   libc-wrap-error-load "libc-wrap-errors/UID-set-invalid-uid.idio" "Invalid argument" EINVAL "setuid"
 })
)

if running-as-root {
  eprintf "NOTICE: EUID == 0: skipping set UID unused UID failure test\n"
  libc-wrap-error-skipped = libc-wrap-error-skipped + 3
} {
  (cond-expand
   ("uname/sysname/SunOS" {
     (cond-expand
      ("os-release/ID/solaris" {
	;; Oracle Solaris 11.4
	libc-wrap-error-load "libc-wrap-errors/UID-set-unused-uid.idio" "Insufficient privileges" EPERM "setuid"
      })
      (else {
	libc-wrap-error-load "libc-wrap-errors/UID-set-unused-uid.idio" "Not owner" EPERM "setuid"
      }))
   })
   (else {
     libc-wrap-error-load "libc-wrap-errors/UID-set-unused-uid.idio" "Operation not permitted" EPERM "setuid"
   }))
}

libc-wrap-error-load "libc-wrap-errors/b-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/b-bad-format.idio" "b?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISBLK-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/c-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/c-bad-format.idio" "c?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISCHR-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/d-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/d-bad-format.idio" "d?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISDIR-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/e-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/e-bad-format.idio" "e?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/f-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/f-bad-format.idio" "f?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISREG-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/l-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/l-bad-format.idio" "l?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISLNK-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/p-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/p-bad-format.idio" "p?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISFIFO-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/r-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/r-bad-format.idio" "r?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/s-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/s-bad-format.idio" "s?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/S_ISSOCK-bad-type.idio" "bad parameter type: '#t' a constant is not a libc/mode_t"

libc-wrap-error-load "libc-wrap-errors/T-bad-type.idio" "bad parameter type: '#t' a constant is not a C/int"

libc-wrap-error-load "libc-wrap-errors/w-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/w-bad-format.idio" "w?: contains an ASCII NUL"

libc-wrap-error-load "libc-wrap-errors/x-bad-type.idio" "bad parameter type: '#t' a constant is not a symbol|string"
libc-wrap-error-load "libc-wrap-errors/x-bad-format.idio" "x?: contains an ASCII NUL"

;; all done?
Skipped = Skipped + libc-wrap-error-skipped
Tests? (libc-wrap-error0 + 400 - libc-wrap-error-skipped)
