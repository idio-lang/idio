#! /usr/bin/env idio

#*

Copyright (c) 2022 Ian Fitchet <idf(at)idio-lang.org>

Licensed under the Apache License, Version 2.0 (the "License"); you
may not use this file except in compliance with the License.  You
may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

------------------------------

pre-compile-lib

We're looking to walk down a hierarchy of .idio files and compile
them.

*#

module compilation

import compile

lib-dir := #f

(regex-case IDIO_CMD_PATH
	    ("(.*)/bin/idio" {
	      lib-dir = append-string r.1 "/lib/idio/" IDIO_MM_VERSION
	    })
	    (else {
	      eprintf "%s: cannot determine library directory from %s\n" ARGV0 IDIO_CMD_PATH
	      exit 1
	    }))

printf "%s: working in %s\n" ARGV0 lib-dir

for fn in (glob (append-string lib-dir "/*.idio")) {
  printf "Compiling %s\n" fn
  (pattern-case fn
		;; Hmm, common theme?  function*/define* ?

		;; doc.idio
		("*/doc.idio" #f)

		;; evaluate.idio
		;; bad parameter type: 'function*' a string is not a pair
		("*/evaluate.idio" #f)

		;; job-control.idio
		;; ^evaluation-error message:"(define-infix-operator): no arguments
		("*/job-control.idio" #f)

		;; object.idio
		;; ^rt-parameter-type-error:bad parameter type: '\n' a string is not a pair
		("*/object.idio" #f)

		;; path-functions.idio
		;; ^rt-parameter-type-error:bad parameter type: '{some docstr}' a string is not a pair
		("*/path-functions.idio" #f)

		;; pty.idio
		;; ^rt-function-arity-error:incorrect arity: 3 args for an arity-1 function
		("*/pty.idio" #f)

		(else {
		  compile-file fn
		}))
  printf "\n\n"
}

;Local Variables:
;mode: Idio
;coding: utf-8-unix
;End:
