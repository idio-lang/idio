#! /usr/bin/env bash

# Copyright (c) 2021 Ian Fitchet <idf@idio-lang.org>
#
# Licensed under the Apache License, Version 2.0 (the "License"); you
# may not use this file except in compliance with the License.  You
# may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
#

# 
# gen-idio-config -- create a system-specific header
#

# This is a poor man's autoconf.

handle_EXIT ()
{
    if [[ ${tmpdir:+X} = X ]] ; then
	cd /
	rm -rf ${tmpdir}
    fi
}

trap handle_EXIT EXIT

set -ue

note ()
{
    :
}

usage () 
{
    cat << EOF >&2

${0##*/} generates a system-specific header/makefile
  -M NAME	module [${opt_module}]

  -v		verbose
EOF
}

opt_module=idio
opt_verbose=

while getopts "hM:v" opt ; do
    case "${opt}" in
    h)
	usage
	exit 0
	;;
    M)
	opt_module=${OPTARG}
	;;
    v)
	opt_verbose=1
	;;
    *)
	usage
	exit 1
	;;
    esac
done

shift $(( OPTIND - 1 ))

######################################################################
#
# pseudo-autoconf

case "$(uname -s)" in
Darwin)
    tmpdir=$(mktemp -d /tmp/${0##*/}.XXXXXX)
    ;;
*)
    tmpdir=$(mktemp -d)
    ;;
esac

names=()

names+=(HAVE_PTSNAME_R)
cat <<EOF > ${tmpdir}/test.c
#define _GNU_SOURCE
#include <stdlib.h>

int main (int argc, char **argv)
{
    char buf[512];
    ptsname_r (0, buf, 512);
    return 0;
}
EOF

HAVE_PTSNAME_R=1
if ! ${CC} -o ${tmpdir}/a.out ${tmpdir}/test.c >/dev/null 2>&1 ; then
    HAVE_PTSNAME_R=0
fi

######################################################################

var_MODULE=$( echo ${opt_module} | tr '[a-z]' '[A-Z]' )
var_header=${opt_module}-config.h

cat <<EOF > ${var_header}
/*
 * generated by ${0##*/} on $(date)
 */

/*
 * ${var_header}
 *
 */

#ifndef ${var_MODULE}_SYSTEM_H
#define ${var_MODULE}_SYSTEM_H

EOF

case "${opt_module}" in
idio)
    (
	for name in ${names[*]} ; do
	    case "${!name}" in
	    1)
		printf "#define %-30s 1\n" ${name}
		;;
	    *)
		printf "#undef  %s\n" ${name}
		;;
	    esac
	done
    ) >> ${var_header}
    ;;
esac

cat <<EOF >> ${var_header}

#endif
EOF

